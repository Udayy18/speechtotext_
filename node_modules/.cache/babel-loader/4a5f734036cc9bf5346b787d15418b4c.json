{"ast":null,"code":"// Copyright (c) Microsoft Corporation. All rights reserved.\n// Licensed under the MIT license.\nimport { AudioOutputFormatImpl } from \"../sdk/Audio/AudioOutputFormat\";\nimport { AudioOutputStream } from \"../sdk/Audio/AudioOutputStream\";\nimport { MessageDataStreamType } from \"./ServiceMessages/ActivityResponsePayload\";\nexport class DialogServiceTurnState {\n  constructor(manager, requestId) {\n    this.privRequestId = requestId;\n    this.privIsCompleted = false;\n    this.privAudioStream = null;\n    this.privTurnManager = manager;\n    this.resetTurnEndTimeout();\n  }\n\n  get audioStream() {\n    // Called when is needed to stream.\n    this.resetTurnEndTimeout();\n    return this.privAudioStream;\n  }\n\n  processActivityPayload(payload, audioFormat) {\n    if (payload.messageDataStreamType === MessageDataStreamType.TextToSpeechAudio) {\n      this.privAudioStream = AudioOutputStream.createPullStream();\n      this.privAudioStream.format = audioFormat !== undefined ? audioFormat : AudioOutputFormatImpl.getDefaultOutputFormat();\n    }\n\n    return this.privAudioStream;\n  }\n\n  endAudioStream() {\n    if (this.privAudioStream !== null && !this.privAudioStream.isClosed) {\n      this.privAudioStream.close();\n    }\n  }\n\n  complete() {\n    if (this.privTimeoutToken !== undefined) {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      clearTimeout(this.privTimeoutToken);\n    }\n\n    this.endAudioStream();\n  }\n\n  resetTurnEndTimeout() {\n    if (this.privTimeoutToken !== undefined) {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      clearTimeout(this.privTimeoutToken);\n    }\n\n    this.privTimeoutToken = setTimeout(() => {\n      this.privTurnManager.CompleteTurn(this.privRequestId);\n      return;\n    }, 2000);\n  }\n\n}","map":{"version":3,"sources":["src/common.speech/DialogServiceTurnState.ts"],"names":[],"mappings":"AAAA;AACA;AAEA,SAAS,qBAAT,QAAsC,gCAAtC;AACA,SAAS,iBAAT,QAA6D,gCAA7D;AAEA,SAAkC,qBAAlC,QAA+D,2CAA/D;AAEA,OAAM,MAAO,sBAAP,CAA6B;AAO/B,EAAA,WAAA,CAAmB,OAAnB,EAA2D,SAA3D,EAA4E;AACxE,SAAK,aAAL,GAAqB,SAArB;AACA,SAAK,eAAL,GAAuB,KAAvB;AACA,SAAK,eAAL,GAAuB,IAAvB;AACA,SAAK,eAAL,GAAuB,OAAvB;AACA,SAAK,mBAAL;AACH;;AAED,MAAW,WAAX,GAAsB;AAClB;AACA,SAAK,mBAAL;AACA,WAAO,KAAK,eAAZ;AACH;;AAEM,EAAA,sBAAsB,CAAC,OAAD,EAAmC,WAAnC,EAAsE;AAC/F,QAAI,OAAO,CAAC,qBAAR,KAAkC,qBAAqB,CAAC,iBAA5D,EAA+E;AAC3E,WAAK,eAAL,GAAuB,iBAAiB,CAAC,gBAAlB,EAAvB;AACA,WAAK,eAAL,CAAqB,MAArB,GAA+B,WAAW,KAAK,SAAjB,GAA8B,WAA9B,GAA4C,qBAAqB,CAAC,sBAAtB,EAA1E;AACH;;AACD,WAAO,KAAK,eAAZ;AACH;;AAEM,EAAA,cAAc,GAAA;AACjB,QAAI,KAAK,eAAL,KAAyB,IAAzB,IAAiC,CAAC,KAAK,eAAL,CAAqB,QAA3D,EAAqE;AACjE,WAAK,eAAL,CAAqB,KAArB;AACH;AACJ;;AAEM,EAAA,QAAQ,GAAA;AACX,QAAI,KAAK,gBAAL,KAA0B,SAA9B,EAAyC;AACrC;AACA,MAAA,YAAY,CAAC,KAAK,gBAAN,CAAZ;AACH;;AACD,SAAK,cAAL;AACH;;AAEO,EAAA,mBAAmB,GAAA;AACvB,QAAI,KAAK,gBAAL,KAA0B,SAA9B,EAAyC;AACrC;AACA,MAAA,YAAY,CAAC,KAAK,gBAAN,CAAZ;AACH;;AACD,SAAK,gBAAL,GAAwB,UAAU,CAAC,MAAW;AAC1C,WAAK,eAAL,CAAqB,YAArB,CAAkC,KAAK,aAAvC;AACA;AACH,KAHiC,EAG/B,IAH+B,CAAlC;AAIH;;AApD8B","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved.\r\n// Licensed under the MIT license.\r\n\r\nimport { AudioOutputFormatImpl } from \"../sdk/Audio/AudioOutputFormat\";\r\nimport { AudioOutputStream, PullAudioOutputStreamImpl } from \"../sdk/Audio/AudioOutputStream\";\r\nimport { DialogServiceTurnStateManager } from \"./DialogServiceTurnStateManager\";\r\nimport { ActivityPayloadResponse, MessageDataStreamType } from \"./ServiceMessages/ActivityResponsePayload\";\r\n\r\nexport class DialogServiceTurnState {\r\n    private privRequestId: string;\r\n    private privIsCompleted: boolean;\r\n    private privAudioStream: PullAudioOutputStreamImpl;\r\n    private privTimeoutToken: any;\r\n    private privTurnManager: DialogServiceTurnStateManager;\r\n\r\n    public constructor(manager: DialogServiceTurnStateManager, requestId: string) {\r\n        this.privRequestId = requestId;\r\n        this.privIsCompleted = false;\r\n        this.privAudioStream = null;\r\n        this.privTurnManager = manager;\r\n        this.resetTurnEndTimeout();\r\n    }\r\n\r\n    public get audioStream(): PullAudioOutputStreamImpl {\r\n        // Called when is needed to stream.\r\n        this.resetTurnEndTimeout();\r\n        return this.privAudioStream;\r\n    }\r\n\r\n    public processActivityPayload(payload: ActivityPayloadResponse, audioFormat?: AudioOutputFormatImpl): PullAudioOutputStreamImpl {\r\n        if (payload.messageDataStreamType === MessageDataStreamType.TextToSpeechAudio) {\r\n            this.privAudioStream = AudioOutputStream.createPullStream() as PullAudioOutputStreamImpl;\r\n            this.privAudioStream.format = (audioFormat !== undefined) ? audioFormat : AudioOutputFormatImpl.getDefaultOutputFormat();\r\n        }\r\n        return this.privAudioStream;\r\n    }\r\n\r\n    public endAudioStream(): void {\r\n        if (this.privAudioStream !== null && !this.privAudioStream.isClosed) {\r\n            this.privAudioStream.close();\r\n        }\r\n    }\r\n\r\n    public complete(): void {\r\n        if (this.privTimeoutToken !== undefined) {\r\n            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\r\n            clearTimeout(this.privTimeoutToken);\r\n        }\r\n        this.endAudioStream();\r\n    }\r\n\r\n    private resetTurnEndTimeout(): void {\r\n        if (this.privTimeoutToken !== undefined) {\r\n            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\r\n            clearTimeout(this.privTimeoutToken);\r\n        }\r\n        this.privTimeoutToken = setTimeout((): void => {\r\n            this.privTurnManager.CompleteTurn(this.privRequestId);\r\n            return;\r\n        }, 2000);\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}